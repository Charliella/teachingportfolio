<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CYBERPUNK 社團系統 v4.1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+TC:wght@500;700;900&display=swap');
    
    body {
      font-family: 'Noto Sans TC', 'Orbitron', sans-serif;
      background-color: #000;
      color: #e2e8f0;
      /* 背景暗化，讓介面更突出 */
      background-image: 
        radial-gradient(circle at 50% 50%, #1a202c 0%, #000 100%);
      height: 100vh;
      width: 100vw;
      overflow: hidden; /* 強制不捲動 */
    }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #00BFFF; }

    .neon-text { text-shadow: 0 0 10px #00BFFF, 0 0 20px #00BFFF, 0 0 40px #00BFFF; }
    .neon-red { text-shadow: 0 0 10px #ff0000, 0 0 30px #ff0000, 0 0 60px #ff0000; }
    
    /* 呼吸閃爍 (60秒內) */
    @keyframes alarm-pulse {
      0%, 100% { box-shadow: inset 0 0 20px #500000; border-color: #800000; background-color: rgba(50, 0, 0, 0.3); }
      50% { box-shadow: inset 0 0 80px #ff0000; border-color: #ff0000; background-color: rgba(150, 0, 0, 0.5); }
    }
    .animate-alarm { animation: alarm-pulse 0.8s infinite ease-in-out; }

    /* 暴力頻閃 (10秒內) */
    @keyframes strobe {
      0% { background-color: #000; border-color: #f00; color: #f00; }
      25% { background-color: #f00; border-color: #fff; color: #000; }
      50% { background-color: #fff; border-color: #f00; color: #f00; }
      75% { background-color: #f00; border-color: #000; color: #fff; }
      100% { background-color: #000; border-color: #f00; color: #f00; }
    }
    .animate-strobe { animation: strobe 0.2s infinite; }

    /* 特殊字體樣式 */
    .font-huge { font-size: clamp(1rem, 2.5vw, 2rem); }
    .font-timer { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <div id="root" class="h-full w-full"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useMemo, useRef } = React;

    // --- 1. Data ---
    const STUDENT_NUMBERS = Array.from({ length: 29 }, (_, i) => i + 1);
    
    // --- 修改處：更新社團清單 ---
    const SPECIFIC_CLUBS = ["扯鈴", "舞蹈", "籃球", "童軍", "跳繩", "跆拳道", "圖書館", "田徑", "生服"];
    const TOTAL_CLUBS = 12; // 維持 12 個，多餘的會自動變為「自訂」

    const DEFAULT_CLUB_NAMES = Array.from({ length: TOTAL_CLUBS }, (_, i) => {
      if (i < SPECIFIC_CLUBS.length) return SPECIFIC_CLUBS[i];
      return `自訂${String(i - SPECIFIC_CLUBS.length + 1).padStart(2, '0')}`;
    });

    // --- 2. Audio ---
    const playSound = (freq, type = 'square') => {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.15);
      } catch (e) {}
    };

    // --- 3. Components ---

    const CountdownTimer = () => {
      const [targetTimeStr, setTargetTimeStr] = useState("");
      const [timeLeft, setTimeLeft] = useState(null);
      const [isRunning, setIsRunning] = useState(false);
      const intervalRef = useRef(null);

      const calculateTimeLeft = (targetStr) => {
        if (!targetStr) return null;
        const now = new Date();
        const [h, m] = targetStr.split(':').map(Number);
        const targetDate = new Date();
        targetDate.setHours(h, m, 0, 0);
        let diff = Math.floor((targetDate - now) / 1000);
        return diff;
      };

      useEffect(() => {
        if (isRunning && targetTimeStr) {
          intervalRef.current = setInterval(() => {
            const diff = calculateTimeLeft(targetTimeStr);
            if (diff !== null) {
              setTimeLeft(diff);
              // 音效邏輯
              if (diff <= 10 && diff > 0) playSound(1200, 'sawtooth'); 
              else if (diff === 0) { playSound(400, 'square'); setIsRunning(false); }
            }
            if (diff <= 0) { clearInterval(intervalRef.current); setTimeLeft(0); setIsRunning(false); }
          }, 1000);
        } else {
          clearInterval(intervalRef.current);
        }
        return () => clearInterval(intervalRef.current);
      }, [isRunning, targetTimeStr]);

      const toggleTimer = () => {
        if (isRunning) {
            setIsRunning(false);
            setTimeLeft(null);
        } else {
            if (!targetTimeStr) return;
            const diff = calculateTimeLeft(targetTimeStr);
            if (diff > 0) {
                setTimeLeft(diff);
                setIsRunning(true);
            } else {
                alert("時間已過或無效");
            }
        }
      };

      const formatTime = (s) => {
        if (s === null) return "--:--";
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
      };

      const isCritical = timeLeft !== null && timeLeft <= 10 && timeLeft > 0;
      const isWarning = timeLeft !== null && timeLeft <= 60 && timeLeft > 0;

      return (
        <div className={`h-full w-full border-4 rounded-2xl flex flex-col items-center justify-center relative overflow-hidden transition-all
          ${isCritical ? 'animate-strobe border-red-500' : 
            isWarning ? 'animate-alarm border-red-600' : 'bg-gray-900/50 border-cyan-500/30'}`}
        >
           {/* 巨大時間顯示 */}
           <div className={`font-black tracking-tighter leading-none font-timer select-none
             ${isCritical ? '' : isWarning ? 'neon-red text-red-500' : 'neon-text text-cyan-400'}`}
             style={{ fontSize: 'min(18vw, 28vh)' }} 
           >
             {formatTime(timeLeft)}
           </div>
           
           {/* 控制區 (時間設定) */}
           <div className="flex gap-2 w-[80%] max-w-md mt-4 z-20">
              {!isRunning ? (
                 <div className="flex flex-1 gap-2">
                    <input 
                        type="time" 
                        value={targetTimeStr}
                        onChange={(e) => setTargetTimeStr(e.target.value)}
                        className="flex-1 bg-gray-800 border-2 border-cyan-600 text-cyan-400 text-center font-mono text-3xl rounded outline-none focus:bg-gray-700 focus:text-cyan-200"
                    />
                    <button onClick={toggleTimer} className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold px-6 rounded text-xl uppercase tracking-wider">
                        START
                    </button>
                 </div>
              ) : (
                 <button onClick={toggleTimer} className="w-full bg-red-600 hover:bg-red-500 border-2 border-red-400 text-white font-bold py-2 text-2xl rounded uppercase animate-pulse">
                    STOP / RESET
                 </button>
              )}
           </div>

           {/* 狀態字 */}
           {timeLeft === 0 && <div className="absolute top-4 text-red-500 font-black text-3xl animate-bounce">TIME UP</div>}
           {isCritical && <div className="absolute top-4 text-red-600 font-black text-3xl">WARNING</div>}
        </div>
      );
    };

    // 主要 App
    const App = () => {
      const [selectedStudents, setSelectedStudents] = useState(new Set());
      const [selectedClub, setSelectedClub] = useState(null);
      
      // --- 修改處：更新 LocalStorage Key 以確保載入新資料 ---
      const STORAGE_KEY = 'cyberpunk-clubs-v4-new'; 

      const [clubNames, setClubNames] = useState(() => {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          return saved ? JSON.parse(saved) : DEFAULT_CLUB_NAMES;
        } catch(e) { return DEFAULT_CLUB_NAMES; }
      });
      const [registrations, setRegistrations] = useState(new Map());
      const [error, setError] = useState(null);

      useEffect(() => localStorage.setItem(STORAGE_KEY, JSON.stringify(clubNames)), [clubNames]);

      const handleToggleStudent = (num) => {
        setSelectedStudents(prev => {
          const n = new Set(prev);
          if (n.has(num)) n.delete(num); else n.add(num);
          return n;
        });
      };

      const handleUpdateClub = (idx, val) => {
        setClubNames(prev => {
          const next = [...prev];
          const old = next[idx];
          next[idx] = val;
          // 更新已登記的名稱
          setRegistrations(regs => {
              const newRegs = new Map();
              regs.forEach((c, s) => newRegs.set(s, c === old ? val : c));
              return newRegs;
          });
          if (selectedClub === old) setSelectedClub(val);
          return next;
        });
      };

      const handleRegister = () => {
        if (selectedStudents.size === 0) return setError("請選擇學生");
        if (!selectedClub) return setError("請選擇社團");
        setRegistrations(prev => {
          const next = new Map(prev);
          selectedStudents.forEach(s => next.set(s, selectedClub));
          return next;
        });
        setSelectedStudents(new Set());
        setError(null);
      };

      const groupedData = useMemo(() => {
        const g = {};
        registrations.forEach((c, s) => { if(!g[c]) g[c]=[]; g[c].push(s); });
        Object.values(g).forEach(arr => arr.sort((a,b)=>a-b));
        return Object.entries(g).sort((a,b) => a[0].localeCompare(b[0], 'zh-Hant'));
      }, [registrations]);

      const registeredSet = new Set(registrations.keys());

      return (
        <div className="flex flex-col h-full p-2 gap-2">
          
          {/* 頂部 Header (極簡化) */}
          <div className="flex justify-between items-center bg-gray-900/80 px-4 py-1 rounded border-b border-cyan-900 h-[5vh] shrink-0">
            <h1 className="text-xl font-bold text-cyan-500 tracking-widest" style={{fontFamily:'Orbitron'}}>CYBERPUNK V4.1</h1>
            <div className="flex items-center gap-4">
               <div className="text-yellow-500 font-mono text-lg">CNT: {registrations.size}</div>
               <button onClick={() => {if(confirm('Clear?')) {setRegistrations(new Map()); setSelectedStudents(new Set());}}} className="text-red-500 text-sm border border-red-900 px-2 hover:bg-red-900">RESET</button>
            </div>
          </div>

          {/* 主要區塊 */}
          <main className="flex-grow flex gap-2 h-[75vh]">
            
            {/* 1. 社團選擇 (左) */}
            <div className="w-[18%] flex flex-col bg-gray-900/40 border border-gray-700 rounded p-1">
               <div className="text-purple-400 text-center font-bold border-b border-gray-700 mb-1 text-lg">社團</div>
               <div className="flex-grow overflow-hidden flex flex-col gap-1">
                  {clubNames.map((name, i) => (
                    <div key={i} 
                         onClick={() => setSelectedClub(name)}
                         className={`flex-1 flex items-center px-2 cursor-pointer transition-all border-l-4 
                         ${selectedClub === name ? 'bg-purple-900/40 border-purple-400' : 'hover:bg-gray-800 border-transparent'}`}>
                       <input value={name} onChange={(e)=>handleUpdateClub(i,e.target.value)}
                              className={`w-full bg-transparent outline-none font-bold text-lg text-left ${selectedClub === name ? 'text-purple-200' : 'text-gray-500'}`} />
                    </div>
                  ))}
               </div>
            </div>

            {/* 2. 學生選擇 (中左) */}
            <div className="w-[22%] flex flex-col bg-gray-900/40 border border-gray-700 rounded p-1">
                <div className="text-cyan-400 text-center font-bold border-b border-gray-700 mb-1 flex justify-between px-2 text-lg">
                    <span>座號</span>
                    {selectedStudents.size > 0 && <span className="text-white bg-cyan-700 px-2 rounded">{selectedStudents.size}</span>}
                </div>
                <div className="flex-grow grid grid-cols-3 gap-1 content-stretch">
                   {STUDENT_NUMBERS.map(num => {
                       const isReg = registeredSet.has(num);
                       const isSel = selectedStudents.has(num);
                       return (
                           <button key={num} onClick={() => !isReg && handleToggleStudent(num)} disabled={isReg}
                                   className={`text-xl font-mono font-bold rounded transition-all flex items-center justify-center
                                   ${isReg ? 'bg-gray-800 text-gray-700 opacity-30' : 
                                     isSel ? 'bg-cyan-500 text-black shadow-[0_0_10px_#00BFFF] scale-105 z-10' : 
                                     'bg-gray-800/60 text-cyan-600 hover:bg-gray-700 hover:text-cyan-300 border border-gray-700'}`}>
                               {num}
                           </button>
                       )
                   })}
                </div>
            </div>

            {/* 3. 名單 (中右) - 文字盡量大 */}
            <div className="w-[25%] flex flex-col bg-gray-900/40 border border-gray-700 rounded p-1 overflow-hidden">
                <div className="text-yellow-500 text-center font-bold border-b border-gray-700 mb-1 flex justify-between px-2 text-lg">
                    <span>名單</span>
                    <button onClick={() => {
                        const txt = groupedData.map(([c,s]) => `${c}: ${s.join(',')}`).join('\n');
                        navigator.clipboard.writeText(txt);
                    }} className="text-xs border border-gray-600 px-1 text-gray-400 hover:text-white">COPY</button>
                </div>
                <div className="flex-grow overflow-y-auto custom-scrollbar flex flex-col gap-1">
                    {groupedData.map(([c, s]) => (
                        <div key={c} className="bg-gray-800/50 p-1 border-l-2 border-yellow-600">
                            <div className="flex justify-between text-yellow-200 font-bold text-lg leading-tight">
                                <span className="truncate">{c}</span>
                                <span className="text-sm opacity-70">{s.length}人</span>
                            </div>
                            <div className="text-gray-300 text-base leading-snug break-words font-mono">
                                {s.join(', ')}
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* 4. 巨型倒數 (右) */}
            <div className="w-[35%] flex flex-col">
                <CountdownTimer />
            </div>

          </main>

          {/* 底部控制與狀態列 */}
          <div className="h-[12vh] shrink-0 flex gap-4">
             <div className="flex-grow border-2 border-cyan-900 bg-gray-900/50 rounded-xl flex items-center justify-center relative overflow-hidden">
                {/* 狀態訊息區 */}
                {error ? (
                    <div className="text-red-500 text-2xl font-bold animate-pulse flex items-center gap-2">
                        <span className="text-4xl">⚠</span> {error}
                    </div>
                ) : (
                    <div className="text-gray-600 font-mono text-xl flex items-center gap-2">
                        <span className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span> 
                        SYSTEM READY ... WAITING FOR INPUT
                    </div>
                )}
             </div>

             {/* 確認按鈕 - 超大 */}
             <button onClick={handleRegister} 
                     disabled={selectedStudents.size === 0 || !selectedClub}
                     className="w-[35%] bg-gradient-to-r from-cyan-700 to-blue-600 hover:from-cyan-500 hover:to-blue-400 text-white font-black text-3xl rounded-xl shadow-[0_0_20px_rgba(0,191,255,0.4)] disabled:opacity-20 disabled:shadow-none transition-all transform active:scale-95 uppercase tracking-[0.2em]">
                 確認登記
             </button>
          </div>

        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
