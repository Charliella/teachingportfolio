<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç‹åœ‹å‹‡è€…ï¼šæ•¸å­¸ä¹‹ç›¾ Final Ultra Pro</title>
    <style>
        :root {
            --neon-green: #00ff41; --neon-orange: #f39c12; --neon-red: #ff003c;
            --neon-blue: #00d2ff; --bg-dark: #0a0a0b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            height: 100dvh; width: 100vw; margin: 0; padding: 0; 
            overflow: hidden; background-color: var(--bg-dark);
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; color: #fff;
        }

        /* ä¸»å®¹å™¨ä½ˆå±€å„ªåŒ– */
        .game-wrapper {
            display: grid;
            grid-template-columns: 1fr 180px; /* å›ºå®šå³å´å¯¬åº¦ */
            grid-template-rows: auto auto 1fr auto; /* æ¨™é¡Œã€çµ±è¨ˆã€é¡Œç›®ã€æŒ‰éˆ• */
            gap: 10px;
            height: 100dvh;
            padding: 10px;
        }

        /* æ¨™é¡Œèˆ‡å›é¥‹å€ */
        .level-header {
            grid-column: 1 / 2;
            background: rgba(243, 156, 18, 0.15);
            border-left: 8px solid var(--neon-orange);
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px;
            height: 60px;
        }
        .level-header h2 { margin: 0; font-size: 24px; color: var(--neon-orange); }
        #feedback { font-size: 24px; font-weight: 900; }

        /* çµ±è¨ˆå¡ç‰‡å€ */
        .stats-row { 
            grid-column: 1 / 2;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
        }
        .stat-card { background: #1a1a1f; border: 1px solid #444; padding: 5px; text-align: center; border-radius: 10px; }
        .stat-label { font-size: 12px; color: #888; display: block; }
        .stat-value { font-size: 18px; font-weight: bold; color: var(--neon-blue); }

        /* é¡Œç›®é¡¯ç¤ºå€ï¼šè‡ªå‹•å»¶ä¼¸å¡«æ»¿ */
        .question-display {
            grid-column: 1 / 2;
            background: #000; border: 3px solid #333;
            display: flex; justify-content: center; align-items: center;
            font-size: 12vh; font-weight: 900; color: var(--neon-green);
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
            text-align: center; border-radius: 15px;
            min-height: 0; /* é—œéµï¼šå…è¨± flex ç¸®å° */
        }

        /* è§£ç­”è¼¸å…¥å€ */
        .answer-row { 
            position: absolute; bottom: 42%; left: 10px; right: 190px;
            display: flex; justify-content: center; gap: 10px; pointer-events: none;
        }
        .input-box {
            background: rgba(0,0,0,0.8); border: 4px solid #555; color: var(--neon-green);
            width: 120px; height: 70px; font-size: 40px; text-align: center; border-radius: 15px;
            pointer-events: auto;
        }
        .input-box.active { border-color: var(--neon-green); box-shadow: 0 0 20px rgba(0, 255, 65, 0.4); }

        /* å³å´æ’è¡Œæ¦œ */
        .side-panel {
            grid-column: 2 / 3;
            grid-row: 1 / 5;
            background: #111; border: 2px solid var(--neon-blue);
            padding: 10px; display: flex; flex-direction: column; border-radius: 15px;
            overflow: hidden;
        }
        .side-panel h3 { font-size: 18px; color: var(--neon-blue); text-align: center; margin: 0 0 10px 0; border-bottom: 1px solid var(--neon-blue); padding-bottom: 5px; }
        .rank-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .rank-item { padding: 6px; font-size: 14px; color: #555; border-bottom: 1px solid #222; }
        .rank-item.active { color: #fff; background: var(--neon-blue); font-weight: bold; border-radius: 5px; }

        /* æ§åˆ¶å€åŸŸï¼šå›ºå®šåœ¨åº•éƒ¨ */
        .controls-row {
            grid-column: 1 / 2;
            display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px;
            height: 38vh; /* å›ºå®šé«˜åº¦ä½”æ¯” */
        }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .key { background: #222; border: 1px solid #666; color: #fff; font-size: 28px; cursor: pointer; border-radius: 12px; font-weight: bold; }
        .key:active { background: #444; }
        .key.action { background: var(--neon-orange); color: #000; }
        .key.delete { background: var(--neon-red); }

        .btn-side { display: flex; flex-direction: column; gap: 8px; }
        .special-btn {
            flex: 1; border: none; font-weight: 900; font-size: 18px; color: #fff; cursor: pointer; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; padding: 5px;
        }
        .cheat-btn { background: #700; border: 2px solid var(--neon-red); }
        .rest-btn { background: #005577; border: 2px solid var(--neon-blue); }

        /* æ•…äº‹å½ˆçª—å„ªåŒ– */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.98); justify-content: center; align-items: center; z-index: 11000;
        }
        .modal-content {
            background: #111; border: 4px solid var(--neon-blue); padding: 20px;
            width: 90vw; height: 90dvh; display: flex; flex-direction: column; border-radius: 20px;
        }
        #restStory { 
            font-size: 20px; color: #f0f0f0; line-height: 1.6; text-align: left; 
            overflow-y: auto; flex-grow: 1; margin: 15px 0; padding: 15px; 
            background: #050505; border-radius: 15px;
        }
        #restStory b { color: var(--neon-orange); }
        #playerName { font-size: 24px; width: 100%; padding: 10px; background: #000; color: var(--neon-blue); border: 2px solid var(--neon-blue); border-radius: 10px; text-align: center; }

        .overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000; 
            display: flex; justify-content: center; align-items: center; padding: 20px; text-align: center;
        }
    </style>
</head>
<body>

<div id="prologueOverlay" class="overlay">
    <div style="max-width: 600px;">
        <h1 style="font-size: 40px; color: var(--neon-orange); margin-bottom: 20px;">âœ¨ ç‹åœ‹ç®—è¡“å±æ©Ÿ âœ¨</h1>
        <p style="font-size: 20px; line-height: 1.5; color: #ccc;">ã€Œå¡çˆ¾å…‹åˆ©äºç‹åœ‹ã€çš„æ•¸å­—æ ¸å¿ƒè¢«æ‰“ç¢äº†ï¼<br>ç¾åœ¨å¤§å®¶éƒ½ä¸æœƒç®—æ•¸å•¦ï¼<br><br><b>ç®—è¡“å‹‡è€…å•Šï¼Œè«‹ç”¨ä½ çš„æ™ºæ…§ä¿®æ­£é€™ä¸€åˆ‡å§ï¼</b></p>
        <button class="key action" style="padding: 15px 40px; font-size: 24px; margin-top: 30px; height: auto;" onclick="startGame()">é–‹å§‹å†’éšªï¼</button>
    </div>
</div>

<div class="game-wrapper">
    <div class="level-header">
        <h2 id="levelTitle">LOADING...</h2>
        <div id="feedback" style="color: #666;">READY</div>
    </div>

    <div class="stats-row">
        <div class="stat-card"><span class="stat-label">èº«åˆ†</span><span class="stat-value" id="lvlStatus">...</span></div>
        <div class="stat-card"><span class="stat-label">é€£å‹</span><span class="stat-value" id="streak">0</span></div>
        <div class="stat-card"><span class="stat-label">å¹³å‡</span><span class="stat-value" id="avgTime">0</span>s</div>
        <div class="stat-card"><span class="stat-label">ç›®æ¨™</span><span id="goalCond" style="font-size:10px; color:#999;">-</span></div>
    </div>

    <div class="question-display" id="questionDisplay">---</div>

    <div class="answer-row">
        <input type="number" class="input-box active" id="ansMain" readonly placeholder="?">
        <div id="remainderZone" style="display:none">
            <input type="number" class="input-box" id="ansRem" readonly placeholder="é¤˜">
        </div>
    </div>

    <div class="side-panel">
        <h3>å‹‡è€…æ’è¡Œæ¦œ</h3>
        <ul class="rank-list" id="rankListDisplay"></ul>
    </div>

    <div class="controls-row">
        <div class="keypad">
            <button class="key" onclick="pressKey(1)">1</button><button class="key" onclick="pressKey(2)">2</button><button class="key" onclick="pressKey(3)">3</button>
            <button class="key" onclick="pressKey(4)">4</button><button class="key" onclick="pressKey(5)">5</button><button class="key" onclick="pressKey(6)">6</button>
            <button class="key" onclick="pressKey(7)">7</button><button class="key" onclick="pressKey(8)">8</button><button class="key" onclick="pressKey(9)">9</button>
            <button class="key delete" onclick="pressKey('C')">C</button><button class="key" onclick="pressKey(0)">0</button>
            <button class="key action" onclick="check()">GO</button>
        </div>
        <div class="btn-side">
            <button class="special-btn cheat-btn" onclick="execCheat()">ç¬é–“æ´å¯Ÿ</button>
            <button class="special-btn rest-btn" onclick="openRest()">ä¼‘æ¯å­˜æª”</button>
            <button class="key" style="background:none; border: 1px solid #444; font-size: 14px;" onclick="location.reload()">é‡æ–°å•Ÿå‹•</button>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--neon-blue); font-size: 32px; margin:0; text-align:center;">ğŸ“– å‹‡è€…å†’éšªæ—¥è¨˜</h2>
        <div id="inputArea">
            <p style="font-size: 18px; margin: 15px 0; text-align:center;">å‹‡è€…çš„åå­—ï¼š</p>
            <input type="text" id="playerName" placeholder="è¼¸å…¥åç¨±...">
        </div>
        <div id="restStory" style="display:none;"></div>
        <button class="key action" style="width:100%; height: 60px; font-size: 24px; margin-top:10px;" id="modalBtn" onclick="confirmRest()">ç¢ºèªå­˜æª”</button>
    </div>
</div>

<script>
    /* ä»¥ä¸‹ JavaScript å…§å®¹å®Œå…¨ä¿ç•™æ‚¨åŸå§‹çš„é‚è¼¯èˆ‡æ•…äº‹é™£åˆ— */
    const levels = [
        { name: "é‹¼éµå‰å“¨ (åŠ æ³•)", type: "add", fast: [4, 3], slow: [8, 7] },
        { name: "å»¢åœŸç”Ÿå­˜ (æ¸›æ³•)", type: "sub", fast: [4, 3], slow: [8, 7] },
        { name: "å½ˆè—¥è£œçµ¦ (ä¹˜æ³•)", type: "multi99", fast: [3, 3], slow: [5, 7] },
        { name: "åŸå¸‚çªæ“Š (2x1)", type: "multi2x1", fast: [6, 3], slow: [14, 7] },
        { name: "ç«åŠ›è¦†è“‹ (2x2)", type: "multi2x2", fast: [10, 3], slow: [20, 7] },
        { name: "ç‹™æ“Šåº§æ¨™ (æ•´é™¤)", type: "divExact", fast: [10, 3], slow: [16, 7] },
        { name: "ç¢ç”²æŒ‡ä»¤ (é¤˜æ•¸I)", type: "divRem1", fast: [12, 3], slow: [26, 7] },
        { name: "æ ¸å¿ƒè§£æ (é¤˜æ•¸II)", type: "divRem2", fast: [16, 3], slow: [40, 6] },
        { name: "ä¹é‡å¤©é–€ (å…«é …é•·å¼)", type: "mix_9", fast: [35, 3], slow: [70, 6] },
        { name: "è«¸ç¥é»ƒæ˜ (åé …ç¥å¼)", type: "mix_10", fast: [45, 3], slow: [90, 6] }
    ];

    const heroes = ["æ‘èŠå¹³æ°‘", "æ–°å…µæˆ°å£«", "åµæŸ¥å°éšŠ", "é‡è£è¡›å…µ", "ç™¾äººéšŠé•·", "ç‹å®®ä¾è¡›", "æ¦®è€€é¨å£«", "å·¨é¾å°‡è»", "ä¸æœ½è‹±é›„", "å‚³èªªåŠè–", "æ•¸å­¸æˆ°ç¥"];
    
    // æ•…äº‹å…§å®¹ (ç¸®æ¸›é¡¯ç¤ºä»¥ä¾¿é è¦½ï¼Œå¯¦éš›ä»£ç¢¼ä¸­è«‹ä¿ç•™æ‚¨å®Œæ•´çš„æ–‡å­—)
    const stories = {
        true: [
            "ã€æ‘èŠå¹³æ°‘ã€‘{name}å›åˆ°äº†å®¶é„‰ï¼Œå¹«è€é—†ç®—æ¸…é›è›‹ï¼Œç²å¾—ç‰¹å¤§è™Ÿé›è›‹ï¼å¤§å®¶ç‚ºä½ æ­¡å‘¼ï¼",
            "ã€æ–°å…µæˆ°å£«ã€‘{name}åœ¨æ¼”æ­¦å ´æ¸…é»å¯¶åŠï¼Œæ­£ç¢ºç­”æ¡ˆå…é™¤äº†è™•ç½°ï¼Œæˆ°å‹å€‘ç´›ç´›è±èµ·å¤§æ‹‡æŒ‡ï¼",
            "ã€åµæŸ¥å°éšŠã€‘{name}æ½›ä¼æ£®æ—ç®—å‡ºæ•µç‡Ÿè¦æ¨¡ï¼Œç¥é€Ÿæƒ…å ±é¿é–‹åŸ‹ä¼ï¼ŒéšŠé•·ç¨±è®šä½ æ˜¯åµæŸ¥çœ¼ï¼",
            "ã€é‡è£è¡›å…µã€‘{name}åˆ†é…å¼©ç‚®é‡é‡ï¼Œç²¾ç¢ºæ•¸å€¼ç©©å¦‚æ³°å±±ï¼Œå¤§å®¶ä»Šæ™šèƒ½å®‰å¿ƒç¡è¦ºäº†ï¼",
            "ã€ç™¾äººéšŠé•·ã€‘{name}çµ±å¸¥æˆ°å£«é å¾ï¼Œè¼•é¬†åˆ†é…å£ç³§ï¼Œå£«å…µå€‘å´‡æ‹œåœ°çœ‹è‘—ä½ ï¼",
            "ã€ç‹å®®ä¾è¡›ã€‘{name}é‹ªè¨­å¤§ç†çŸ³åœ°ç£šï¼Œå®Œç¾å¥‘åˆç„¡ç¸«éš™ï¼Œåœ‹ç‹æ‘˜ä¸‹ç‹å† è‡´æ„ï¼",
            "ã€æ¦®è€€é¨å£«ã€‘{name}å¹³åˆ†éºµåŒ…çµ¦æ‘æ°‘ï¼Œå±•ç¾æ™ºæ…§èˆ‡å…¬æ­£ï¼Œæ•¸å­—æ˜¯å®ˆè­·æ­£ç¾©çš„ç›¾ï¼",
            "ã€å·¨é¾å°‡è»ã€‘{name}é§•é¦­å·¨é¾è¨ˆç®—æ°£å£“ï¼Œç²¾æº–é™è½å¡”å°–ï¼Œå…¨åŸå·¨é¾ç‚ºä½ å’†å“®ï¼",
            "ã€ä¸æœ½è‹±é›„ã€‘{name}æ‹†è§£é‚è¼¯ä¹‹å¡”å°å°ï¼Œé‡‘å…‰å¤§ä½œéœ§éœ¾æ¶ˆå¤±ï¼Œæˆç‚ºæ­·å²æ°¸æ†è‹±é›„ï¼",
            "ã€æ•¸å­¸æˆ°ç¥ã€‘è«¸ç¥é»ƒæ˜é™è‡¨ï¼Œ{name}åŠƒä¸‹æœ€çµ‚è§£ç­”é‡æ­¸æ˜Ÿè¾°è»Œé“ï¼Œå®‡å®™ç§©åºä¹‹æ ¸å¿ƒï¼"
        ],
        false: [
            "ã€å‡çš„æ‘èŠå¹³æ°‘ã€‘{name}ç®—éŒ¯é›è›‹ï¼Œè€é—†æ‹¿æƒå¸šè¿½ä½ ï¼Œå…¨æ‘å°ç‹—éƒ½åœ¨å˜²ç¬‘ä½ ï¼",
            "ã€å‡çš„æ–°å…µæˆ°å£«ã€‘{name}æŠ„éŒ¯è§£ç­”å ±å‡ºä¸ƒåä¸ƒè¬éš»å¤§è±¡ï¼Œæ•™å®˜æ°£ç˜‹ï¼Œä½ è¢«ä»™äººæŒåˆºåˆ°å¤§å«ï¼",
            "ã€å‡çš„åµæŸ¥å°éšŠã€‘{name}æŠŠä¸ƒå€‹æ•µäººç®—æˆä¸ƒè¬ï¼Œå…¨è»æ’¤é€€äº”åå…¬é‡Œï¼Œçµæœäººå®¶åœ¨çƒ¤åœ°ç“œï¼",
            "ã€å‡çš„é‡è£è¡›å…µã€‘{name}ç›”ç”²è£¡å¡æ£‰èŠ±ç³–ï¼Œé‡å¿ƒä¸ç©©æ»¾é€²è­·åŸæ²³ï¼Œä¸Ÿè‡‰åˆ°å¤–å¤ªç©ºï¼",
            "ã€å‡çš„ç™¾äººéšŠé•·ã€‘{name}æŠŠéºµåŒ…ç®—æˆçŸ³é ­ï¼Œå£«å…µæŠŠä½ ä¸Ÿé€²æ± å¡˜é¤µé­šï¼Œä½œå¼Šå¤±éˆå•¦ï¼",
            "ã€å‡çš„ç‹å®®ä¾è¡›ã€‘{name}åœ°ç£šå †æˆå°å±±å·®é»åŸ‹æ‰åœ‹ç‹ï¼Œè¢«è®Šæˆå™´æ°´é›•åƒæ¯å¤©è¢«è²“æŠ“ç™¢ï¼",
            "ã€å‡çš„æ¦®è€€é¨å£«ã€‘{name}æŠŠé¤…ä¹¾ç®—é€²è‡ªå·±å˜´è£¡ï¼Œä½œå¼Šæ¢å™´å‡ºä¾†è²¼åœ¨é›£æ°‘è‡‰ä¸Šï¼Œå°·å°¬é‘½åœ°æ´ï¼",
            "ã€å‡çš„å·¨é¾å°‡è»ã€‘{name}ä½œå¼Šæ¢æ¿•æ‰ï¼Œè¼‰è‘—ç«é¾è¡é€²å…¬å…±å»æ‰€ï¼Œæ›è‘—è¡›ç”Ÿç´™çˆ¬å‡ºä¾†ï¼",
            "ã€å‡çš„ä¸æœ½è‹±é›„ã€‘{name}å¤§å–Š1+1ç­‰æ–¼ä¹åä¹å…†ï¼Œè¢«å¡”éˆè®Šæˆç©¿èŠ­è•¾èˆè£™çš„æ²³é¦¬è·³èˆï¼",
            "ã€å‡çš„æ•¸å­¸æˆ°ç¥ã€‘{name}èªª10æ¸›10ç­‰æ–¼é›è›‹é¤…ï¼Œå…¨å ´çˆ†ç¬‘ï¼Œæˆ°ç¥è²¼ç´™æ˜¯è²·ä¸€é€ä¸€æ›ä¾†çš„ï¼"
        ]
    };

    let curLvl = 0, targetAns = 0, targetRem = 0, streak = 0, times = [], startTime, activeInput = 'main', isCheated = false;

    function startGame() { document.getElementById('prologueOverlay').style.display = 'none'; generate(); }

    function updateRankBoard() {
        const list = document.getElementById('rankListDisplay');
        const p = isCheated ? "å‡çš„" : ""; 
        list.innerHTML = heroes.map((h, i) => `<li class="rank-item ${i === curLvl ? 'active' : ''}">${i}.${p}${h}</li>`).join('');
    }

    function generate() {
        const lvl = levels[curLvl];
        document.getElementById('lvlStatus').innerText = (isCheated ? "å‡çš„" : "") + heroes[curLvl];
        document.getElementById('levelTitle').innerText = lvl.name;
        document.getElementById('goalCond').innerText = `${lvl.fast[0]}s/${lvl.fast[1]}å‹ æˆ– ${lvl.slow[0]}s/${lvl.slow[1]}å‹`;
        document.getElementById('remainderZone').style.display = lvl.type.includes('Rem') ? 'block' : 'none';
        
        let qText = "", n1, n2;
        switch(lvl.type) {
            case "mix_9": let r9 = buildProExpr(8, 50, 250); qText = r9.q; targetAns = r9.a; break;
            case "mix_10": let r10 = buildProExpr(10, 500, 999); qText = r10.q; targetAns = r10.a; break;
            case "divExact": do { n2 = rand(3, 16); } while (n2 % 5 === 0); targetAns = rand(11, 40); n1 = n2 * targetAns; qText = `${n1} Ã· ${n2}`; break;
            case "divRem1": do { n2 = rand(6, 25); } while (n2 % 5 === 0); n1 = rand(50, 250); targetAns = Math.floor(n1/n2); targetRem = n1%n2; qText = `${n1} Ã· ${n2}`; break;
            case "divRem2": do { n2 = rand(16, 51); } while (n2 % 5 === 0); n1 = rand(300, 1500); targetAns = Math.floor(n1/n2); targetRem = n1%n2; qText = `${n1} Ã· ${n2}`; break;
            case "add": n1 = rand(10, 99); n2 = rand(10, 99); qText = `${n1}+${n2}`; targetAns = n1+n2; break;
            case "sub": n1 = rand(100, 300); n2 = rand(10, 99); qText = `${n1}-${n2}`; targetAns = n1-n2; break;
            case "multi99": n1 = rand(4, 9); n2 = rand(4, 9); qText = `${n1}Ã—${n2}`; targetAns = n1*n2; break;
            case "multi2x1": n1 = rand(21, 99); n2 = rand(3, 9); qText = `${n1}Ã—${n2}`; targetAns = n1*n2; break;
            case "multi2x2": n1 = rand(11, 49); n2 = rand(11, 39); qText = `${n1}Ã—${n2}`; targetAns = n1*n2; break;
        }
        document.getElementById('questionDisplay').innerText = qText;
        document.getElementById('ansMain').value = ""; document.getElementById('ansRem').value = "";
        activeInput = 'main'; updateInputFocus(); startTime = Date.now(); updateRankBoard();
    }

    function buildProExpr(count, min, max) {
        let ops = ['+', '-', '*'], expr = [rand(min, max)];
        for(let i=1; i<count; i++) {
            let op = ops[rand(0, 2)];
            let val = (op === '*') ? rand(2, 6) : rand(min, max);
            expr.push(op); expr.push(val);
        }
        let s = expr.join(' ');
        return { q: s.replace(/\*/g, 'Ã—'), a: eval(s) };
    }

    function pressKey(k) {
        let t = (activeInput === 'main') ? document.getElementById('ansMain') : document.getElementById('ansRem');
        if (k === 'C') t.value = ""; else t.value += k;
    }

    function check() {
        const uA = parseInt(document.getElementById('ansMain').value), uR = parseInt(document.getElementById('ansRem').value || 0);
        const dur = (Date.now() - startTime) / 1000;
        let ok = (uA === targetAns);
        if (levels[curLvl].type.includes('Rem')) ok = (ok && uR === targetRem);

        if (ok) {
            streak++; times.push(dur);
            const avg = (times.reduce((a,b)=>a+b,0)/times.length).toFixed(1);
            document.getElementById('avgTime').innerText = avg;
            showFb("é­”æ³•æ ¸å‡†", "var(--neon-green)");
            if ((streak >= levels[curLvl].fast[1] && avg <= levels[curLvl].fast[0]) || (streak >= levels[curLvl].slow[1] && avg <= levels[curLvl].slow[0])) upgrade();
        } else {
            streak = 0; times = []; document.getElementById('avgTime').innerText = "0";
            showFb("é­”åŠ›æ’æ–¥", "var(--neon-red)");
        }
        document.getElementById('streak').innerText = streak; generate();
    }

    function execCheat() { isCheated = true; updateRankBoard(); document.getElementById('ansMain').value = targetAns; document.getElementById('ansRem').value = targetRem || 0; setTimeout(() => { upgrade(); generate(); }, 200); }

    function upgrade() { if (curLvl < levels.length - 1) { curLvl++; streak = 0; times = []; alert("ç­‰ç´šæ™‰å‡ï¼"); } else { alert("æˆå°±é”æˆï¼šç§©åºä¸»å®°è€…ï¼"); location.reload(); } }

    function openRest() { document.getElementById('modal').style.display = 'flex'; }
    function confirmRest() {
        const nameVal = document.getElementById('playerName').value || "ä½šåå‹‡è€…";
        document.getElementById('inputArea').style.display = 'none';
        document.getElementById('restStory').style.display = 'block';
        document.getElementById('modalBtn').innerText = "é—œé–‰å­˜æª”æ—¥è¨˜";
        document.getElementById('modalBtn').onclick = () => location.reload();
        
        let storyTemplate = stories[(!isCheated).toString()][curLvl];
        let finalStr = storyTemplate.split("{name}").join(`<b>${nameVal}</b>`);
        document.getElementById('restStory').innerHTML = finalStr;
    }

    function updateInputFocus() { document.getElementById('ansMain').classList.toggle('active', activeInput === 'main'); document.getElementById('ansRem').classList.toggle('active', activeInput === 'rem'); }
    document.getElementById('ansMain').onclick = () => { activeInput = 'main'; updateInputFocus(); };
    document.getElementById('ansRem').onclick = () => { activeInput = 'rem'; updateInputFocus(); };
    function showFb(t, c) { const f = document.getElementById('feedback'); f.innerText = t; f.style.color = c; }
    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
</script>
</body>
</html>
